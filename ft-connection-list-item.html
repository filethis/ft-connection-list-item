<!--
Copyright 2017 FileThis, Inc.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->


<link rel="import" href="../polymer/polymer.html">

<link rel="import" href="../iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../iron-label/iron-label.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-spinner/paper-spinner-lite.html">
<link rel="import" href="../iron-icon/iron-icon.html">

<!--
`ft-connection-list-item`
An element that renders a single FileThis connection resource as a list item

@demo demo/index.html
-->

<dom-module id="ft-connection-list-item">

    <style include="iron-flex iron-flex-alignment"></style>

    <style is="custom-style">
      paper-spinner-lite.spinner
      {
          --paper-spinner-color: black;
          --paper-spinner-stroke-width: 2px;
          width: 17px;
          height: 17px;
      }
    </style>

    <template>

        <div
                id="interior"
                class="layout horizontal center"
                style="width:475px; height:70px; padding-left:20px; padding-right:20px;">

            <!-- Name -->
            <iron-label style="width:165px; font-family:Arial; font-size:15px;">
                [[connection.name]]
            </iron-label>

            <!-- Spacer -->
            <div class="flex"></div>
            <div style="width:25px;"></div>

            <!-- Logo -->
            <div class="layout horizontal center center-justified"
                 style="width:102px; height:72px;">
                <img
                        style="width:auto; max-width:100%;"
                        src="[[connection.logoUrl]]">
                </img>
            </div>

            <!-- Spacer -->
            <div style="width:25px;"></div>

            <!-- Action button and refresh date -->
            <div
                    id="actionButtonAndRefreshDate"
                    class="layout vertical center"
                    style="width:120px;">

                <!-- Action button -->
                <paper-button
                        raised
                        id="actionButton"
                        style="width:100px; height:32px; background-color:white"
                        on-click="_onActionButtonClicked">
                    <iron-icon id="icon"></iron-icon>
                    <div style="width:3px;"></div>
                    <iron-label
                            id="buttonLabel"
                            style="font-family:Arial; font-size:12px;"></iron-label>
                </paper-button>

                <!-- Refresh date -->
                <iron-label
                        id="refreshDate"
                        style="margin-top:6px; font-family:Arial; font-size:small; font-style:italic;">
                    [[_getRefreshDateString(connection)]]
                </iron-label>
            </div>

            <!-- Spinner and label -->
            <div
                    id="spinnerAndLabel"
                    class="layout horizontal center"
                    style="width:120px;">

                <!-- Spinner -->
                <paper-spinner-lite
                        id="spinner"
                        class="spinner">
                </paper-spinner-lite>

                <div style="width:6px;"></div>

                <!-- Label -->
                <iron-label
                        id="spinnerLabel"
                        style="font-family:Arial; font-size:12px; text-transform:uppercase; padding-top:2px">
                </iron-label>
            </div>

        </div>

    </template>

    <script>
        Polymer({

            is: 'ft-connection-list-item',

            /**
             * Fired when the the action button is clicked.
             * The event detail argument is the item's connection resource.
             *
             * @event action-button-clicked
             * @param {Object} detail The selected connection.
             */

            properties: {

                /** The connection resource to be displayed. */
                connection: {
                    type: Object,
                    notify: true,
                    value: null
                },

                /** Whether the item should appear selected, or not. */
                selected: {
                    type: Boolean,
                    notify: true,
                    value: false,
                    observer: "_onSelectedChanged"
                }

            },

            observers:
            [
                "_onConnectionStateChanged(connection.state)"
            ],

            _onConnectionStateChanged: function(state)
            {
                if (this.connection === null)
                    return;

                var label;
                var icon;
                var working;
                switch (this.connection.state)
                {
                    case "waiting":
                        label = "Refresh";
                        icon = "refresh";
                        working = false;
                        break;
                    case "connecting":
                        label = "Connecting";
                        icon = "refresh";
                        working = true;
                        break;
                    case "uploading":
                        label = "Downloading";
                        icon = "refresh";
                        working = true;
                        break;
                    case "question":
                        label = "Fix It";
                        icon = "report-problem";
                        working = false;
                        break;
                    case "error":
                        label = "Fix It";
                        icon = "report-problem";
                        working = false;
                        break;
                    default:
                        label = "Refresh";
                        icon = "refresh";
                        working = false;
                        break;
                }
                this.$.buttonLabel.innerHTML = label;
                this.$.spinnerLabel.innerHTML = label;
                this.$.icon.icon = icon;
                this.$.actionButtonAndRefreshDate.hidden = working;
                this.$.spinnerAndLabel.hidden = !working;
                this.$.spinner.active = working;
            },

            _onSelectedChanged: function()
            {
                var interior = this.$.interior;
                if (this.selected)
                    interior.style.backgroundColor = "#F6F6F6";
                else
                    interior.style.backgroundColor = "#FFFFFF";
            },

            _onActionButtonClicked: function(event, detail)
            {
                // TODO: The following is not preventing toggle of the selection...
                event.stopPropagation(); // So that we don't toggle the item selection when the button is clicked
                event.preventDefault();

                this.fire('action-button-clicked', this.connection);
            },

            _getRefreshDateString: function formatDate(connection)
            {
                if (this.connection === null)
                    return "";

                var checkedDate = new Date(connection.checkedDate);

                const checkedYear = checkedDate.getYear();
                const year1970 = 117;
                const hasNeverFetched = (checkedYear < year1970);
                if (hasNeverFetched)
                    return "";

                var monthNames =
                    [
                        "Jan", "Feb", "Mar",
                        "Apr", "May", "Jun", "Jul",
                        "Aug", "Sep", "Oct",
                        "Nov", "Dec"
                    ];

                var day = checkedDate.getDate();
                var monthIndex = checkedDate.getMonth();

                return "Refreshed " + monthNames[monthIndex] + ' ' + day;
            }

        });
    </script>
</dom-module>
